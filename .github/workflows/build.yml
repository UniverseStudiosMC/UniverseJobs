name: 🔨 Build & Test

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build:
    name: 🔨 Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      
    - name: ☕ Setup Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'
        
    - name: 🔍 Display Maven Version
      run: mvn --version
      
    - name: 🧹 Clean & Validate
      run: mvn clean validate
      
    - name: 🔨 Compile
      run: mvn compile
      
    - name: 📦 Package
      run: mvn package -DskipTests
      
    - name: 🔍 Verify JAR Creation
      shell: bash
      run: |
        JAR_FILE=$(find target -name "JobsAdventure-*.jar" -type f | head -1)
        if [[ -f "$JAR_FILE" ]]; then
          echo "✅ JAR created successfully: $JAR_FILE"
          echo "📊 File size: $(ls -lh "$JAR_FILE" | awk '{print $5}')"
          echo "🔍 JAR contents:"
          jar -tf "$JAR_FILE" | head -20
        else
          echo "❌ JAR file not found!"
          exit 1
        fi
        
    - name: 📈 Upload Build Artifacts (Ubuntu only)
      if: matrix.os == 'ubuntu-latest'
      uses: actions/upload-artifact@v4
      with:
        name: JobsAdventure-snapshot-${{ github.sha }}
        path: target/JobsAdventure-*.jar
        retention-days: 7
        
  code-quality:
    name: 🔍 Code Quality Check
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      
    - name: ☕ Setup Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'
        
    - name: 🔍 Analyze Dependencies
      run: |
        echo "🔍 Analyzing project dependencies..."
        mvn dependency:tree
        
    - name: 🛡️ Security Check
      run: |
        echo "🛡️ Checking for known vulnerabilities..."
        mvn org.owasp:dependency-check-maven:check || true
        
    - name: 📊 Generate Project Report
      run: |
        echo "📊 Generating project statistics..."
        echo "## 📊 Project Statistics" > project-stats.md
        echo "- **Java Version**: $(mvn help:evaluate -Dexpression=java.version -q -DforceStdout)" >> project-stats.md
        echo "- **Maven Version**: $(mvn --version | head -1)" >> project-stats.md
        echo "- **Build Time**: $(date)" >> project-stats.md
        echo "- **Total Source Files**: $(find src -name "*.java" | wc -l)" >> project-stats.md
        echo "- **Lines of Code**: $(find src -name "*.java" -exec cat {} \; | wc -l)" >> project-stats.md
        
    - name: 📈 Upload Stats
      uses: actions/upload-artifact@v4
      with:
        name: project-statistics
        path: project-stats.md
        retention-days: 30