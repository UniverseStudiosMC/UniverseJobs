name: ðŸ”¨ Build & Test

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build:
    name: ðŸ”¨ Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: â˜• Setup Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'
        
    - name: ðŸ” Display Maven Version
      run: mvn --version
      
    - name: ðŸ§¹ Clean & Validate
      run: mvn clean validate
      
    - name: ðŸ”¨ Compile
      run: mvn compile
      
    - name: ðŸ“¦ Package
      run: mvn package -DskipTests
      
    - name: ðŸ” Verify JAR Creation
      shell: bash
      run: |
        JAR_FILE=$(find target -name "JobsAdventure-*.jar" -type f | head -1)
        if [[ -f "$JAR_FILE" ]]; then
          echo "âœ… JAR created successfully: $JAR_FILE"
          echo "ðŸ“Š File size: $(ls -lh "$JAR_FILE" | awk '{print $5}')"
          echo "ðŸ” JAR contents:"
          jar -tf "$JAR_FILE" | head -20
        else
          echo "âŒ JAR file not found!"
          exit 1
        fi
        
    - name: ðŸ“ˆ Upload Build Artifacts (Ubuntu only)
      if: matrix.os == 'ubuntu-latest'
      uses: actions/upload-artifact@v4
      with:
        name: JobsAdventure-snapshot-${{ github.sha }}
        path: target/JobsAdventure-*.jar
        retention-days: 7
        
  code-quality:
    name: ðŸ” Code Quality Check
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: â˜• Setup Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'
        
    - name: ðŸ” Analyze Dependencies
      run: |
        echo "ðŸ” Analyzing project dependencies..."
        mvn dependency:tree
        
    - name: ðŸ›¡ï¸ Security Check
      run: |
        echo "ðŸ›¡ï¸ Checking for known vulnerabilities..."
        mvn org.owasp:dependency-check-maven:check || true
        
    - name: ðŸ“Š Generate Project Report
      run: |
        echo "ðŸ“Š Generating project statistics..."
        echo "## ðŸ“Š Project Statistics" > project-stats.md
        echo "- **Java Version**: $(mvn help:evaluate -Dexpression=java.version -q -DforceStdout)" >> project-stats.md
        echo "- **Maven Version**: $(mvn --version | head -1)" >> project-stats.md
        echo "- **Build Time**: $(date)" >> project-stats.md
        echo "- **Total Source Files**: $(find src -name "*.java" | wc -l)" >> project-stats.md
        echo "- **Lines of Code**: $(find src -name "*.java" -exec cat {} \; | wc -l)" >> project-stats.md
        
    - name: ðŸ“ˆ Upload Stats
      uses: actions/upload-artifact@v4
      with:
        name: project-statistics
        path: project-stats.md
        retention-days: 30